kind: pipeline
type: docker
name: default

steps:
  - name: setup
    image: busybox
    commands:
      - echo "Setting up the environment"

  - name: install_dependencies
    image: composer:latest
    commands:
      - cp .env.example .env
      - composer install
      - php artisan key:generate
      - ./vendor/bin/sail up -d
      - sleep 20

  - name: run_migrations
    image: laravelsail/php80-composer:latest
    environment:
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: your_database
      DB_USERNAME: your_username
      DB_PASSWORD: your_password
    commands:
      - ./vendor/bin/sail artisan migrate --force

  - name: run_tests
    image: laravelsail/php80-composer:latest
    environment:
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: your_database
      DB_USERNAME: your_username
      DB_PASSWORD: your_password
    commands:
      - ./vendor/bin/sail test

services:
  mysql:
    image: mysql:latest
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: your_database
      MYSQL_USER: your_username
      MYSQL_PASSWORD: your_password
    ports:
      - 3306:3306

  redis:
    image: redis:latest
    ports:
      - 6379:6379

volumes:
  - name: vendor
    temp: {}

trigger:
  event:
    - push
    - pull_request
  branch:
    - master
    - drone-pipeline
